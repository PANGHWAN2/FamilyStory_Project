<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header">
    <title>Hello</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<style>
    div>img:hover{
        opacity: 80%;
        cursor:pointer;
    }
    h5{
        margin-bottom: 25px;
    }
    hr{
        opacity: 10%;
    }
</style>
<body>
<div class="container">
    <div th:replace="fragments/bodyHeader :: bodyHeader" />

    <div id="wrapper">
        <!--<div id="buttonBox">
            <div id="groupBtn">
                <a href="/AfterJoin"><img src="/AdminImage/group.png" width="30px"/></a>
            </div>
            <div id="settingBtn">
                <a th:href="@{/users/settinguser}"><img src="/AdminImage/setting.png" width="30px"/></a>
            </div>
        </div>-->


        <div id="navBox">
            <h5>내 그룹</h5>
            <div id="myTeams">
            </div>
            <br/><br/>
            <h5>구성원</h5>
            <div id="userInSameTeam">
            </div>
            <hr/>

            <h4>알림</h4>
            <div id="notice">
            </div>
            <hr/>

            <h4>1년전 우리는</h4>
            <div id="agoYearPhoto">
            </div>
            <hr/>
        </div>

        <div id="contentBox">

            <div id="userData">
            </div>
            <div id="uploadBtnBox">
                <button id="uploadBtn" type="button">+</button>
            </div>

            <div id="contents">
            </div>
            <hr/>
        </div>
    </div>



    <div th:replace="fragments/footer :: footer" /> <!-- fragments/footer에 있는 파일이 대체됨 -->
</div> <!-- /container -->
</body>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script>

    var curURL = window.location.href;
    console.log(curURL);
    var urlArr = curURL.split("/");
    var currentTID = urlArr[urlArr.length-1];
    console.log(currentTID);

    //로그인 사용자 정보를 받아옴
    $.ajax({
        type: "get",
        url: "/initMainPage/loginUser",
        datatype: 'json',
        success: function(data) {
            console.log(data);
            getMyTeams();
            initInformation(currentTID);

            var userData = document.getElementById('userData');
<!--            userData.innerHTML = "<h4>현재 로그인한 아이디 : "+data.userID+"</h4>";-->
        },
        error: function(request, status, error) {
            console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
        }
    });

    function getMyTeams(){
        console.log('getMyTeams 함수 안');
        $.ajax({
            type: "get",
            url: "/initMainPage/myTeams",
            datatype: 'json',
            success: function(data) {
                console.log('myTeams');
                console.log(data);

                var myTeams = document.getElementById('myTeams'); // div
                data.forEach(function(item){
                    let teamimg = document.createElement('img');
                    teamimg.setAttribute("src",item.teamImage);
                    teamimg.setAttribute("style",'width:53px; height:53px; border-radius: 50%; margin-bottom:10px;')
                    teamimg.setAttribute("id",item.tid);
                    teamimg.addEventListener("click", getInformation);

                    let teamName = document.createElement('div');
                    teamName.innerHTML = item.teamID;
                    teamName.setAttribute("style","text-align:center;font-weight:bolder")

                    let eachTeam = document.createElement('div');
                    eachTeam.append(teamimg);
                    eachTeam.append(teamName);
                    eachTeam.setAttribute("style","float:left; margin-right:30px; margin-bottom:15px")
                    /*
                    var teamBtn = document.createElement("button");
                    teamBtn.setAttribute("type", "button");
                    teamBtn.setAttribute("class", "teamBtn");
                    teamBtn.setAttribute("id", item.tid);
                    teamBtn.addEventListener("click", getInformation);
*/
                    // teamBtn.appendChild(teamText);
                    myTeams.appendChild(eachTeam);
                    myTeams.setAttribute("style","display:inline-block");
                    // myTeams.appendChild(teamName)
                });

            },
            error: function(request, status, error) {
                console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
            }
        });
    }

    function initInformation(currentTID){
        console.log('initInformation 함수 안');
        console.log(currentTID);
        var btn = document.getElementById('uploadBtn');
        <!--        btn.setAttribute("onclick", "location.href='/uploadContent/"+currentTID+"'");-->
        btn.setAttribute("onclick", "location.href='/uploadContent'");
        console.log(btn.getAttribute('href'));

        var curTeam = document.getElementById('curTeam');
<!--        curTeam.innerHTML = "<h4>현재 속한 그룹(이건 TID) : "+currentTID+"</h4>";-->

        var notice = document.getElementById('notice');
        notice.innerHTML = '';

        $.ajax({
            type: "post",
            url: "/initMainPage/contents",
            data: {
                tID : currentTID
            },
            datatype: 'json',
            success: function(data) {
                console.log('contents');
                console.log(data);
                showContents(data);
            },
            error: function(request, status, error) {
                console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
            }
        });
        $.ajax({
            type: "post",
            url: "/initMainPage/teamEvents",
            data: {
                tID : currentTID
            },
            datatype: 'json',
            success: function(data) {
                console.log('teamEvents');
                console.log(data);
                showTeamEvent(data);
            },
            error: function(request, status, error) {
                console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
            }
        });
        $.ajax({
            type: "post",
            url: "/initMainPage/todayBirthday",
            data: {
                tID : currentTID
            },
            datatype: 'json',
            success: function(data) {
                console.log('birthday');
                console.log(data);
                showBirthday(data);
            },
            error: function(request, status, error) {
                console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
            }
        });
        $.ajax({
            type: "post",
            url: "/initMainPage/newRequest",
            data: {
                tID : currentTID
            },
            datatype: 'json',
            success: function(data) {
                console.log('newRequest');
                console.log(data);
                showNewRequest(data);
            },
            error: function(request, status, error) {
                console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
            }
        });


        $.ajax({
            type: "post",
            url: "/initMainPage/userInSameTeam",
            data: {
                tID : currentTID
            },
            datatype: 'json',
            success: function(data) {
                console.log('userInSameTeam');
                console.log(data);
                showUserInSameTeam(data, currentTID);
            },
            error: function(request, status, error) {
                console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
            }
        });

        //agoYear ----------------------------------------------

        $.ajax({
            type: "post",
            url: "/agoYear",
            data: {
                tID : currentTID
            },
            datatype: 'json',
            success: function(data) {
                console.log("성공적으로 받아옴")
                showAgoYear(data);
            },
            error: function(request, status, error) {
                console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
            }
        });

        // ----------------------------------------------

    }

    function getInformation(evt){
        console.log('getInformation 함수 안');
        console.log(evt.target);
        var currentTID = $(evt.target).attr('id');
        console.log(currentTID);

        var btn = document.getElementById('uploadBtn');
        <!--        btn.setAttribute("onclick", "location.href='/uploadContent/"+currentTID+"'");-->
        btn.setAttribute("onclick", "location.href='/uploadContent'");
        console.log(btn.getAttribute('href'));

        //현재
        var curTeam = document.getElementById('curTeam');
<!--        curTeam.innerHTML = "<h4>현재 속한 그룹(이건 TID) : "+currentTID+"</h4>";-->

        var notice = document.getElementById('notice');
        notice.innerHTML = '';

        $.ajax({
            type: "post",
            url: "/initMainPage/contents",
            data: {
                tID : currentTID
            },
            datatype: 'json',
            success: function(data) {
                console.log('contents');
                console.log(data);
                showContents(data);
            },
            error: function(request, status, error) {
                console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
            }
        });
        $.ajax({
            type: "post",
            url: "/initMainPage/teamEvents",
            data: {
                tID : currentTID
            },
            datatype: 'json',
            success: function(data) {
                console.log('teamEvents');
                console.log(data);
                showTeamEvent(data);
            },
            error: function(request, status, error) {
                console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
            }
        });
        $.ajax({
            type: "post",
            url: "/initMainPage/todayBirthday",
            data: {
                tID : currentTID
            },
            datatype: 'json',
            success: function(data) {
                console.log('birthday');
                console.log(data);
                showBirthday(data);
            },
            error: function(request, status, error) {
                console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
            }
        });
        $.ajax({
            type: "post",
            url: "/initMainPage/newRequest",
            data: {
                tID : currentTID
            },
            datatype: 'json',
            success: function(data) {
                console.log('newRequest');
                console.log(data);
                showNewRequest(data);
            },
            error: function(request, status, error) {
                console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
            }
        });


        $.ajax({
            type: "post",
            url: "/initMainPage/userInSameTeam",
            data: {
                tID : currentTID
            },
            datatype: 'json',
            success: function(data) {
                console.log('userInSameTeam');
                console.log(data);
                showUserInSameTeam(data, currentTID);
            },
            error: function(request, status, error) {
                console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
            }
        });



        //    ------- agoYear  함수 -------

        $.ajax({
            type: "post",
            url: "/agoYear",
            data: {
                tID : currentTID
            },
            datatype: 'json',

            success: function(data) {
                console.log('teamEvents');
                console.log(data);
                showAgoYear(data);
            },
            error: function(request, status, error) {
                console.log("code: "+request.status+"\n message: "+request.reponseText+"\n error: "+error);
            }
        });
    }

    function showAgoYear(data){
        console.log("showAgoYear함수 안")
        var contents = document.getElementById('agoYearPhoto');
        contents.innerHTML = '';
        data.forEach(function(p){
            var imgBox = document.createElement("div");
            var img = document.createElement("img");
            img.setAttribute("src", p);
            img.setAttribute("width", "200px");
            img.setAttribute("height", "160px");
            imgBox.appendChild(img);
            contents.appendChild(imgBox);
        });
    }
    //----------------------- agoyear 함수 끝 ------------------------------------

    function showUserInSameTeam(data, currentTID){
        console.log('showUserInSameTeam 함수 안');

        var userInSameTeam = document.getElementById('userInSameTeam');
        userInSameTeam.innerHTML = '';
        data.forEach(function(item){
            // var userBtn = document.createElement("button");
            let memberimg = document.createElement("img")
            memberimg.setAttribute("src",item.userImage);
            memberimg.setAttribute("style","width:53px; height:53px; border-radius:50%; margin-bottom:7px;")
            memberimg.setAttribute("id",item.uid+" "+currentTID);
            memberimg.addEventListener("click", movePersonalPage);
            // userBtn.setAttribute("type", "button");
            // userBtn.setAttribute("class", "userBtn");
            // userBtn.setAttribute("id", item.uid+" "+currentTID);
            // userBtn.addEventListener("click", movePersonalPage);

            let memberName = document.createElement("div");
            memberName.innerHTML = item.nickName
            memberName.setAttribute("style","display:inline-block; margin-left:14px; font-weight:bolder")

            let eachMember = document.createElement('div');
            eachMember.append(memberimg);
            eachMember.append(memberName);
            eachMember.setAttribute("style","margin-right:30px; margin-bottom:7px;")

            // var userText = document.createTextNode(item.nickName);
            // userBtn.appendChild(userText);
            userInSameTeam.appendChild(eachMember);
            // userInSameTeam.setAttribute("style","display:inline-block")
        });
    }

    function movePersonalPage(evt){
        var userBtnID = $(evt.target).attr('id');
        var ids = userBtnID.split(' ');
        console.log(ids[0]);
        console.log(ids[1]);
        location.href = '/uploadList/'+ids[1]+'/'+ids[0];
    }

    function showTeamEvent(data){
        console.log('showTeamEvent 함수 안');

        var notice = document.getElementById('notice');
        data.forEach(function(item){
            var teText = document.createElement("span");
            teText.innerHTML = '오늘은 '+item.eventDate+'로 '+item.eventName+'입니다.<br>';

            notice.appendChild(teText);
        });
    }

    function showBirthday(data){
        console.log('showBirthday 함수 안');

        var notice = document.getElementById('notice');
        data.forEach(function(item){
            var bText = document.createElement("span");
            bText.innerHTML = '오늘은 '+item.birthday+'로 '+item.nickName+'의 생일 입니다.<br>';

            notice.appendChild(bText);
        });
    }

    function showNewRequest(data){
        console.log('showNewRequest 함수 안');

        var notice = document.getElementById('notice');
        data.forEach(function(item){
            var nqText = document.createElement("span");
            nqText.innerHTML = item.name+'님이 가입 요청을 보냈습니다! 그룹 관리에서 확인해주세요.<br>';

            notice.appendChild(nqText);
        });
    }

    function showContents(data){
        console.log('showContents 함수 안');

        var contents = document.getElementById('contents');
        contents.innerHTML = '';
        data.forEach(function(item){
            var head = document.createElement("div");
            head.setAttribute("class", "headerContent");
            var userImg = document.createElement("img");
            if(item.userImage == null){
                 userImg.setAttribute("src", "/AdminImage/userIcon.png");
            }
            else{
                userImg.setAttribute("src", item.userImage);
            }
            userImg.setAttribute("class", "userImage");
            head.appendChild(userImg);
            var headText = document.createElement("span");
            headText.innerHTML = item.userNickname;
            head.appendChild(headText);

            var cContainer = document.createElement("div");
            cContainer.setAttribute("class", "carousel-container");

            var cSlide = document.createElement("div");
            cSlide.setAttribute("class", "carousel-slide");
            cSlide.setAttribute("data", 0);
            cContainer.appendChild(cSlide);

            var imgCount = 0;
            var photo = item.photoRoute.split(' ');
            photo.forEach(function(p){
                var img = document.createElement("img");
                img.setAttribute("src", p);
                img.setAttribute("class", "contentImg");
                cSlide.appendChild(img);
                imgCount++;
            });
            cSlide.setAttribute("count", imgCount);

            var pButton = document.createElement("button");
            pButton.addEventListener('click', ()=> {
                let counter = cSlide.attributes.data.value;
                console.log(counter);
                const size = 400;
                cSlide.style.transform = 'translateX(' + (-size * counter) + 'px)';

                console.log('p 버튼');
                if(counter <= 0) return;
                cSlide.style.transition = "transform 0.4s ease-in-out";
                counter--;
                cSlide.style.transform = 'translateX(' + (-size * counter) + 'px)';

                cSlide.attributes.data.value = counter;
            });
            pButton.setAttribute("id", "prevBtn");
            var pBtnText = document.createTextNode("<");
            pButton.appendChild(pBtnText);
            cContainer.appendChild(pButton);


            var nButton = document.createElement("button");
            nButton.addEventListener('click', ()=> {
                let counter = cSlide.attributes.data.value;
                console.log(counter);
                const size = 400;
                cSlide.style.transform = 'translateX(' + (-size * counter) + 'px)';

                let imgCount = cSlide.attributes.count.value;
                console.log('n 버튼');
                console.log(imgCount);

                if(counter >= imgCount-1) return;
                cSlide.style.transition = "transform 0.4s ease-in-out";
                counter++;
                cSlide.style.transform = 'translateX(' + (-size * counter) + 'px)';

                cSlide.attributes.data.value = counter;
            });
            nButton.setAttribute("id", "nextBtn");
            var nBtnText = document.createTextNode(">");
            nButton.appendChild(nBtnText);
            cContainer.appendChild(nButton);

            var foot = document.createElement("div");
            foot.setAttribute("class", "footerContent");
            var footText = document.createElement("span");
            footText.innerHTML = item.explanation+" "+item.location+"<br>"+item.when;
            foot.appendChild(footText);

            var content = document.createElement("div");
            content.setAttribute("class", "content");

            content.appendChild(head);
            content.appendChild(cContainer);
            content.appendChild(foot);

            contents.appendChild(content);
       });
    }
</script>
</html>