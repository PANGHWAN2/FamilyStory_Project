<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Family Story</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .btnx-indigo{
            background: var(--bs-indigo); background: #C3EFBE; border: none;);
            color: #5C9204;
        }
    </style>
    <script th:inline="javascript">
        let myTeam = [[${myTeam}]];
        let joinCheck = [[${joinCheck}]];

    </script>
    <script>
        jQuery(document).ready(function () {
            console.log("Dddd")

            console.log(joinCheck.length)
            // 사용자가 이미 팀에 소속되어 있거나, 요청을 한 상태면 버튼을 비활성화
            if (myTeam != null || joinCheck != null) {
                for (var i = 0; i < myTeam.length; i++) {
                    // $('input[name=' + myTeam[i] + ']').attr("disabled", true);
                    console.log(joinCheck[i])
                    if (joinCheck[i] == true) {
                        $('input[name=' + myTeam[i] + ']').attr("value", "팀원");
                        $('input[name=' + myTeam[i] + ']').attr("disabled", true);
                    } else {
                        $('input[name=' + myTeam[i] + ']').attr("value", "요청 취소");
                    }
                }
            }

            $('input[name=teamId]').click(function(){
                $(this).val("");
            })
            // $('input[type=button]').click(function () {
            $('input[value="가입 요청"]').click(function () {
                let res = confirm("가입 요청을 하시겠습니까?")
                let id = this.name;
                const this1 = $(this);
                if(res){
                    $.ajax({
                        type: "POST",
                        url: "RequestTeam",
                        data: {id: id},
                        success: function (res) {
                            if (res == 1) {
                                alert("요청이 완료되었습니다.");
                             //   location.href="/"
                                history.go(0);
                            } else {
                                alert("이미 요청된 사항입니다.")
                            }
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                }
            })

            $('input[value="요청 취소"]').click(function () {
                let res = confirm("요청을 취소하시겠습니까?")
                console.log('요청취소?')
                let id = this.name;
                console.log(id)
                const this2 = $(this);
                if(res){
                    $.ajax({
                        type: "POST",
                        url: "RequestTeamCancel",
                        data: {id: id},
                        success: function (res) {
                            // console.log("넘어갔다");
                                console.log("res " + res)
                            if (res == 1) {
                                alert("요청이 취소되었습니다.");
                                this2.val("가입 요청")
                                // this1.attr("disabled", true);
                                history.go(0)
                            }
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                }
            })
        })

    </script>
</head>
<body>
<div th:replace="./fragments/bodyHeader :: bodyHeader"/>

<div class="container">
    <div>
        <form class="row mb-3" th:action="@{/SearchingTeam}">
            <div class="col-sm-11">
                <input class="form-control form-control-lg" type="text" name="teamId" th:value="${param.teamId}" placeholder="그룹 ID를 검색하세요"/>
            </div>
            <div class="col-sm-1">
                <button id="searchbtn" type="submit" class="btn btn-success btnx-indigo"><i class="bi bi-search" style="font-size: 1.5em;"></i></button>
            </div>
        </form>
    </div>
<!--    <div>총 ㅣ <span th:text="${teams.totalElements}"></span></div>-->
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <th>그룹번호</th>
            <th>그룹 ID</th>
            <th>그룹명</th>
            <th>가입하기</th>
        </thead>
        <tbody>
            <tr th:each="team : ${teams}" id="dataTable">
                <th th:text="${team.TID}">1</th>
                <td th:text="${team.TeamID}"></td>
                <td th:text="${team.TeamName}"></td>
                <td><input type="button" value="가입 요청" id="join" th:name="${team.TeamID}"></td>
            </tr>
            <tr th:if="${size==0}">
                <td colspan="4" style="text-align: center">해당하는 그룹 아이디가 존재하지 않습니다.</td>
            </tr>
        </tbody>
    </table>
    <div th:if="${size!=0}">
        <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${1 ==currentPage} ? 'disabled'" >
                    <a class="page-link" href="#" th:href="@{/SearchingTeam(page=${currentPage-1},teamId=${param.teamId})}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item" th:classappend="${idx ==currentPage} ? 'disabled'" th:each="idx:${#numbers.sequence(startPage,endPage)}">
                    <a class="page-link" href="#" th:href="@{/SearchingTeam(page=${idx-1},teamId=${param.teamId})}" th:text="${idx}"></a></li>

                <li class="page-item" th:classappend="${teams.totalPages ==currentPage} ? 'disabled'">
                    <a class="page-link" href="#" th:href="@{/SearchingTeam(page=${currentPage},teamId=${param.teamId})}"  aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>
<div th:replace="./fragments/footer :: footer"/>
</body>
<hr>
</html>
